name: Limpar HWIDs expirados

on:
  schedule:
    - cron: "*/5 * * * *"   # roda a cada 5 minutos
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Remover HWIDs expirados
      run: |
        now_ts=$(date +%s)

        > HWIDS.new
        > expired.log

        while IFS="|" read -r hash date; do
          hash=$(echo "$hash" | xargs)
          date=$(echo "$date" | xargs)

          if [ -z "$date" ]; then
            echo "$hash" >> HWIDS.new
            continue
          fi

          # converte DD-MM-YYYY - HH:MM â†’ YYYY-MM-DD HH:MM
          formatted=$(echo "$date" | sed -E 's|([0-9]{2})-([0-9]{2})-([0-9]{4}) - ([0-9]{2}:[0-9]{2})|\3-\2-\1 \4|')
          exp_ts=$(date -d "$formatted" +%s)

          if [ "$exp_ts" -gt "$now_ts" ]; then
            echo "$hash | $date" >> HWIDS.new
          else
            echo "$hash | $date" >> expired.log
          fi
        done < HWIDS.txt

        mv HWIDS.new HWIDS.txt

    - name: Avisar no Discord
      run: |
        if [ -s expired.log ]; then
          msg="ðŸ§¹ **HWIDs expirados removidos:**\n"
          while read line; do
            msg="$msgâ€¢ \`$line\`\n"
          done < expired.log

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\":\"$msg\"}" \
               ${{ secrets.DISCORD_WEBHOOK }}
        fi

    - name: Commit automÃ¡tico
      run: |
        git config user.name "HWID-Bot"
        git config user.email "bot@github.com"
        git add HWIDS.txt
        git commit -m "Removendo HWIDs expirados" || exit 0
        git push
