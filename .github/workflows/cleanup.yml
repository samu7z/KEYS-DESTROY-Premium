name: Limpar HWIDs expirados

on:
  schedule:
    - cron: "*/5 * * * *"   # roda a cada 5 minutos
  workflow_dispatch:         # permite rodar manualmente

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
    # 1ï¸âƒ£ pega o repositÃ³rio
    - uses: actions/checkout@v4

    # 2ï¸âƒ£ processa o HWIDS.txt e remove os expirados
    - name: Remover HWIDs expirados
      run: |
        # timestamp atual
        now_ts=$(date +%s)

        # cria arquivos temporÃ¡rios
        > HWIDS.new
        > expired.log

        # lÃª linha por linha
        while IFS="|" read -r hash date; do
          hash=$(echo "$hash" | xargs)
          date=$(echo "$date" | xargs)

          # se nÃ£o tiver data, mantÃ©m
          if [ -z "$date" ]; then
            echo "$hash" >> HWIDS.new
            continue
          fi

          # converte DD-MM-YYYY - HH:MM â†’ YYYY-MM-DD HH:MM
          formatted=$(echo "$date" | sed -E 's|([0-9]{2})-([0-9]{2})-([0-9]{4}) - ([0-9]{2}:[0-9]{2})|\3-\2-\1 \4|')

          # timestamp da expiraÃ§Ã£o
          exp_ts=$(date -d "$formatted" +%s)

          # compara
          if [ "$exp_ts" -gt "$now_ts" ]; then
            echo "$hash | $date" >> HWIDS.new    # ainda vÃ¡lido
          else
            echo "$hash | $date" >> expired.log  # expirou
          fi
        done < HWIDS.txt

        # substitui arquivo original
        mv HWIDS.new HWIDS.txt

    # 3ï¸âƒ£ envia log para o Discord se houver expirados
    - name: Avisar no Discord
      run: |
        if [ -s expired.log ]; then
          msg="ðŸ§¹ **HWIDs expirados removidos:**\n"
          while read line; do
            msg="$msgâ€¢ \`$line\`\n"
          done < expired.log

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\":\"$msg\"}" \
               ${{ secrets.DISCORD_WEBHOOK }}
        fi

    # 4ï¸âƒ£ commit automÃ¡tico
    - name: Commit automÃ¡tico
      run: |
        git config user.name "HWID-Bot"
        git config user.email "bot@github.com"
        git add HWIDS.txt
        git commit -m "Removendo HWIDs expirados" || exit 0
        git push
