name: Limpar HWIDs expirados

on:
  schedule:
    - cron: "*/5 * * * *" # roda a cada 5 minutos
  workflow_dispatch:       # permite rodar manualmente

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
    # 1ï¸âƒ£ Pega o repositÃ³rio
    - uses: actions/checkout@v4

    # 2ï¸âƒ£ Processa HWIDS.txt e remove expirados
    - name: Remover HWIDs expirados
      run: |
        now_ts=$(date +%s)
        > HWIDS.new
        > expired.log

        while IFS="|" read -r hash date; do
          hash=$(echo "$hash" | xargs)
          date=$(echo "$date" | xargs)

          if [ -z "$date" ]; then
            echo "$hash" >> HWIDS.new
            continue
          fi

          # converte DD-MM-YYYY - HH:MM â†’ YYYY-MM-DD HH:MM apenas internamente
          day=$(echo "$date" | cut -d- -f1)
          month=$(echo "$date" | cut -d- -f2)
          year=$(echo "$date" | cut -d- -f3 | cut -d' ' -f1)
          time=$(echo "$date" | cut -d' ' -f3)
          formatted="$year-$month-$day $time"

          exp_ts=$(date -d "$formatted" +%s)

          # compara com hora atual
          if [ "$exp_ts" -gt "$now_ts" ]; then
            echo "$hash | $date" >> HWIDS.new
          else
            echo "$hash | $date" >> expired.log
          fi
        done < HWIDS.txt

        mv HWIDS.new HWIDS.txt

    # 3ï¸âƒ£ Log no Discord
    - name: LOGS - DISCORD
      run: |
        if [ -s expired.log ]; then
          msg="# \\ðŸ§¹ãƒ»Limpado HWID's TemporÃ¡rios"$'\n'
          while read line; do
            msg="$msg- \`$line\`"$'\n'
          done < expired.log

          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{"content": "'"$msg"'"}' \
               ${{ secrets.DISCORD_WEBHOOK }}
        fi

    # 4ï¸âƒ£ Commit automÃ¡tico
    - name: COMMIT
      run: |
        git config user.name "HWID-Bot"
        git config user.email "bot@github.com"
        git add HWIDS.txt
        git commit -m "Removendo HWIDs expirados" || exit 0
        git push
